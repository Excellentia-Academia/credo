<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Exercice d'√âpellation Vocale - Avec Scores</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(270deg, #6a11cb, #2575fc, #6a11cb);
      background-size: 600% 600%;
      animation: gradientAnimation 15s ease infinite;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 24px;
    }
    @keyframes gradientAnimation {
      0% {background-position: 0% 50%;}
      50% {background-position: 100% 50%;}
      100% {background-position: 0% 50%;}
    }
    .container {
      background: rgba(255, 255, 255, 0.1);
      padding: 32px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(12px);
      max-width: 600px;
      width: 100%;
      text-align: center;
      animation: fadeIn 1.2s ease;
    }
    @keyframes fadeIn { from {opacity: 0; transform: translateY(15px);} to {opacity: 1; transform: translateY(0);} }

    h1 { font-weight: 800; margin-bottom: 12px; font-size: 2rem; text-shadow: 0 3px 8px rgba(0, 0, 0, 0.3); }
    
    .stats-bar {
      display: flex;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.15);
      padding: 12px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 0.95rem;
    }
    
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .stat-value {
      font-weight: bold;
      font-size: 1.2rem;
      color: #00e676;
    }
    
    .stat-label {
      font-size: 0.85rem;
      opacity: 0.9;
      margin-top: 4px;
    }
    
    #wordDisplay { 
      font-size: 2.2rem; 
      font-weight: bold; 
      letter-spacing: 0.15em; 
      margin: 14px 0 18px; 
      min-height: 50px;
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 10px;
      border: 2px dashed rgba(255, 255, 255, 0.2);
    }

    .page-controls {
      display: grid; 
      grid-template-columns: 1fr auto 1fr; 
      gap: 10px; 
      align-items: center; 
      margin: 8px 0 16px;
    }
    
    .page-controls button, .page-controls select {
      padding: 10px; 
      border-radius: 10px; 
      border: none; 
      font-size: 1rem; 
      background: #fff; 
      color: #2575fc;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
      cursor: pointer;
    }
    
    .page-controls button:hover { 
      background: #2575fc; 
      color: #fff; 
      box-shadow: 0 0 12px #ffffff99, 0 0 18px #2575fcaa; 
    }

    #progress { 
      font-size: 1rem; 
      margin-bottom: 8px; 
      opacity: 0.95; 
      font-weight: 600;
      background: rgba(255, 255, 255, 0.1);
      padding: 8px;
      border-radius: 8px;
    }

    input[type="text"] {
      font-size: 1.2rem; 
      padding: 14px; 
      border-radius: 10px; 
      border: none; 
      width: 100%; 
      margin: 10px 0 16px;
      background-color: #fff; 
      color: #333; 
      outline: none; 
      transition: all 0.3s ease;
    }
    
    input[type="text"]:focus { 
      box-shadow: 0 0 10px #2575fc; 
      caret-color: #2575fc; 
    }

    .buttons {
      display: flex; 
      flex-wrap: wrap; 
      justify-content: center; 
      gap: 12px; 
      margin-top: 6px;
    }
    
    button {
      flex: 1 1 40%;
      padding: 12px;
      font-size: 1.05rem;
      font-weight: 600;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: #fff;
      color: #2575fc;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    button:hover {
      background: #2575fc;
      color: #fff;
      box-shadow: 0 0 12px #ffffff99, 0 0 18px #2575fcaa;
    }
    
    #btnSaveScore {
      background: linear-gradient(135deg, #00e676, #00c853);
      color: white;
      margin-top: 10px;
    }
    
    #btnSaveScore:hover {
      background: linear-gradient(135deg, #00c853, #00e676);
    }
    
    #message {
      margin-top: 18px;
      font-size: 1.05rem;
      font-weight: 600;
      min-height: 32px;
      transition: color 0.3s ease;
    }
    
    .score-summary {
      background: rgba(255, 255, 255, 0.15);
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      animation: fadeIn 0.5s ease;
    }
    
    .score-summary h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #00e676;
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Exercice d'√âpellation Vocale</h1>
    
    <!-- Barre de statistiques -->
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-value" id="scoreValue">0</div>
        <div class="stat-label">Score</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="correctValue">0</div>
        <div class="stat-label">R√©ussis</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="attemptsValue">0</div>
        <div class="stat-label">Tentatives</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="accuracyValue">0%</div>
        <div class="stat-label">Pr√©cision</div>
      </div>
    </div>

    <!-- Contr√¥les de pagination -->
    <div class="page-controls">
      <button id="btnPrevPage" title="Page pr√©c√©dente">‚üµ Page</button>
      <div>
        Page <select id="pageSelect"></select><span id="totalPagesLabel"></span>
      </div>
      <button id="btnNextPage" title="Page suivante">Page ‚ü∂</button>
    </div>

    <div id="progress">Question ‚Äî / 10 (page ‚Äî)</div>
    <div id="wordDisplay">Mot √† √©couter</div>

    <input type="text" id="answer" placeholder="√âcris le mot ici..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
    
    <div class="buttons">
      <button id="btnPlay">‚ñ∂Ô∏è Jouer</button>
      <button id="btnSlow">üê¢ Ralentir</button>
      <button id="btnFast">üêá Acc√©l√©rer</button>
      <button id="btnRepeat">üîÅ R√©p√©ter</button>
      <button id="btnSkip">‚è≠ Passer</button>
      <button id="btnBack">‚¨ÖÔ∏è Retour</button>
    </div>
    
    <button id="btnSaveScore" class="hidden">üíæ Enregistrer le score</button>
    
    <div id="message"></div>
    
    <!-- R√©sum√© du score en fin d'exercice -->
    <div id="scoreSummary" class="score-summary hidden">
      <h3>R√©sum√© de votre performance</h3>
      <p>Score final : <span id="finalScore">0</span> points</p>
      <p>R√©ponses correctes : <span id="finalCorrect">0</span>/<span id="finalTotal">0</span></p>
      <p>Taux de r√©ussite : <span id="finalAccuracy">0%</span></p>
      <p>Temps moyen par r√©ponse : <span id="averageTime">0s</span></p>
    </div>
  </div>

  <script>
    // Donn√©es de l'exercice
    const words = [
      "autel","bataille","ch√¥mage","documentaire","√©tang","force","gazouiller","hache",
      "atome","bibliographie","crustac√©","documentaliste","√©rosion","fantastique","gam√®te","hormone",
      "altercation","bip√®de","conductible","dictionnaire","√©tiquette","fant√¥me","gyn√©cologue","herbivore",
      "acide","bourgeon","croquis","d√©limitation","√©cart","format","gentiment","harmonieux",
      "amplitude","bidonville","cylindre","descendre","√©paisseur","fonctionnement","gabarit","hypoth√®se"
    ];

    /* === Syst√®me de scores === */
    let score = 0;
    let correctAnswers = 0;
    let totalAttempts = 0;
    let sessionStartTime = null;
    let responseTimes = [];
    let currentExerciseStart = null;

    /* === Pagination === */
    const pageSize = 10;
    const totalPages = Math.ceil(words.length / pageSize);
    let currentPage = 1;
    let currentWordIndex = 0;
    let speechRate = 1;
    let exerciseCompleted = false;

    /* === DOM === */
    const wordDisplay = document.getElementById("wordDisplay");
    const answerInput = document.getElementById("answer");
    const message = document.getElementById("message");
    const btnPlay = document.getElementById("btnPlay");
    const btnSlow = document.getElementById("btnSlow");
    const btnFast = document.getElementById("btnFast");
    const btnRepeat = document.getElementById("btnRepeat");
    const btnSkip = document.getElementById("btnSkip");
    const btnBack = document.getElementById("btnBack");
    const btnSaveScore = document.getElementById("btnSaveScore");
    const progress = document.getElementById("progress");
    const pageSelect = document.getElementById("pageSelect");
    const btnPrevPage = document.getElementById("btnPrevPage");
    const btnNextPage = document.getElementById("btnNextPage");
    const totalPagesLabel = document.getElementById("totalPagesLabel");
    
    // √âl√©ments de statistiques
    const scoreValue = document.getElementById("scoreValue");
    const correctValue = document.getElementById("correctValue");
    const attemptsValue = document.getElementById("attemptsValue");
    const accuracyValue = document.getElementById("accuracyValue");
    
    // √âl√©ments du r√©sum√©
    const scoreSummary = document.getElementById("scoreSummary");
    const finalScore = document.getElementById("finalScore");
    const finalCorrect = document.getElementById("finalCorrect");
    const finalTotal = document.getElementById("finalTotal");
    const finalAccuracy = document.getElementById("finalAccuracy");
    const averageTime = document.getElementById("averageTime");

    /* === Mise √† jour des statistiques === */
    function updateStats() {
      scoreValue.textContent = score;
      correctValue.textContent = correctAnswers;
      attemptsValue.textContent = totalAttempts;
      
      const accuracy = totalAttempts > 0 ? Math.round((correctAnswers / totalAttempts) * 100) : 0;
      accuracyValue.textContent = `${accuracy}%`;
      
      // Couleur selon la pr√©cision
      if (accuracy >= 80) accuracyValue.style.color = "#00e676";
      else if (accuracy >= 60) accuracyValue.style.color = "#ffb300";
      else accuracyValue.style.color = "#ff5252";
    }

    /* === Gestion du temps de r√©ponse === */
    function startResponseTimer() {
      currentExerciseStart = Date.now();
    }

    function recordResponseTime() {
      if (currentExerciseStart) {
        const timeTaken = (Date.now() - currentExerciseStart) / 1000; // en secondes
        responseTimes.push(timeTaken);
        currentExerciseStart = null;
      }
    }

    /* === Calcul du score === */
    function calculateScore(wordLength, timeTaken, isCorrect) {
      if (!isCorrect) return 0;
      
      // Points de base selon la longueur du mot
      let basePoints = Math.min(wordLength * 5, 50);
      
      // Bonus pour rapidit√©
      let timeBonus = 0;
      if (timeTaken < 3) timeBonus = 20;
      else if (timeTaken < 5) timeBonus = 10;
      else if (timeTaken < 8) timeBonus = 5;
      
      return basePoints + timeBonus;
    }

    /* === Helpers pagination === */
    function pageStartIndex(page) { return (page - 1) * pageSize; }
    function pageEndIndex(page) { return Math.min(page * pageSize - 1, words.length - 1); }
    function indexInCurrentPage() { return currentWordIndex - pageStartIndex(currentPage); }

    function updateProgress() {
      const pos = indexInCurrentPage() + 1;
      const end = pageEndIndex(currentPage) - pageStartIndex(currentPage) + 1;
      progress.textContent = `Question ${pos}/${end} (page ${currentPage}/${totalPages})`;
    }

    function updatePageSelect() {
      pageSelect.innerHTML = "";
      for(let p = 1; p <= totalPages; p++) {
        const opt = document.createElement("option");
        opt.value = String(p);
        opt.textContent = p;
        if (p === currentPage) opt.selected = true;
        pageSelect.appendChild(opt);
      }
      totalPagesLabel.textContent = ` / ${totalPages}`;
    }

    /* === Synth√®se vocale === */
    function speakWord(word, rate = speechRate) {
      if (!('speechSynthesis' in window)) {
        message.textContent = "La synth√®se vocale n'est pas prise en charge sur ce navigateur.";
        return;
      }
      speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(word);
      utterance.lang = "fr-FR";
      utterance.rate = rate;
      speechSynthesis.speak(utterance);
    }

    /* === Jeu === */
    function playWord() {
      if (exerciseCompleted) return;
      
      const word = words[currentWordIndex];
      wordDisplay.textContent = "";
      speakWord(word);
      message.textContent = "√âcoutez attentivement et √©crivez le mot.";
      message.style.color = "#fff";
      answerInput.value = "";
      answerInput.disabled = false;
      answerInput.focus();
      updateProgress();
      
      // D√©marrer le chrono pour cette r√©ponse
      startResponseTimer();
    }

    function playWordSlow() { 
      speechRate = Math.max(0.5, speechRate - 0.25); 
      playWord(); 
    }
    
    function playWordFast() { 
      speechRate = Math.min(2, speechRate + 0.25); 
      playWord(); 
    }
    
    function repeatWord() { 
      playWord(); 
    }

    function normalize(str) {
      return str.trim().toLowerCase().replace(/\s+/g, ' ');
    }

    function checkAnswer() {
      if (exerciseCompleted) return;
      
      recordResponseTime();
      totalAttempts++;
      
      const userAnswer = normalize(answerInput.value);
      const correctAnswer = normalize(words[currentWordIndex]);
      const wordLength = correctAnswer.length;
      const timeTaken = responseTimes[responseTimes.length - 1] || 0;
      
      if (userAnswer === correctAnswer) {
        const pointsEarned = calculateScore(wordLength, timeTaken, true);
        score += pointsEarned;
        correctAnswers++;
        
        message.textContent = `‚úÖ Correct ! +${pointsEarned} points`;
        message.style.color = "#00e676";
        wordDisplay.textContent = correctAnswer;
        
        setTimeout(() => { 
          nextWord(); 
        }, 1200);
      } else {
        message.textContent = "‚ùå Incorrect, √©coutez l'orthographe lettre par lettre.";
        message.style.color = "#ff5252";
        spellWord(correctAnswer);
      }
      
      updateStats();
    }

    function spellWord(word) {
      speechSynthesis.cancel();
      let letters = [...word.replace(/[-\s]/g, "")];
      let i = 0;
      function spellNext() {
        if (i < letters.length) {
          const utterance = new SpeechSynthesisUtterance(letters[i]);
          utterance.lang = "fr-FR";
          utterance.rate = 0.6;
          utterance.onend = () => {
            i++;
            setTimeout(spellNext, 350);
          };
          speechSynthesis.speak(utterance);
        } else {
          message.textContent = "R√©essayez d'√©crire le mot.";
          message.style.color = "#fff";
          answerInput.value = "";
          answerInput.focus();
          startResponseTimer();
        }
      }
      spellNext();
    }

    function nextWord() {
      const end = pageEndIndex(currentPage);
      if (currentWordIndex < end) {
        currentWordIndex++;
        playWord();
      } else {
        endExercise();
      }
    }

    function prevWord() {
      const start = pageStartIndex(currentPage);
      if (currentWordIndex > start) {
        currentWordIndex--;
        message.textContent = "";
        playWord();
      }
    }

    /* === Fin de l'exercice === */
    function endExercise() {
      exerciseCompleted = true;
      answerInput.disabled = true;
      
      const accuracy = totalAttempts > 0 ? Math.round((correctAnswers / totalAttempts) * 100) : 0;
      const avgTime = responseTimes.length > 0 
        ? (responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length).toFixed(1)
        : "0";
      
      // Afficher le r√©sum√©
      finalScore.textContent = score;
      finalCorrect.textContent = correctAnswers;
      finalTotal.textContent = totalAttempts;
      finalAccuracy.textContent = `${accuracy}%`;
      averageTime.textContent = `${avgTime}s`;
      
      scoreSummary.classList.remove("hidden");
      btnSaveScore.classList.remove("hidden");
      
      message.textContent = `üéâ Exercice termin√© ! Score : ${score} points`;
      message.style.color = "#00e676";
    }

    /* === Navigation de pages === */
    function goToPage(p) {
      if (exerciseCompleted) {
        // R√©initialiser pour une nouvelle page
        exerciseCompleted = false;
        scoreSummary.classList.add("hidden");
        btnSaveScore.classList.add("hidden");
      }
      
      const page = Math.max(1, Math.min(totalPages, p));
      currentPage = page;
      currentWordIndex = pageStartIndex(currentPage);
      updatePageSelect();
      message.textContent = "";
      playWord();
    }

    /* === Sauvegarde du score === */
    function saveScore() {
      // Ici, vous int√©grerez avec votre syst√®me de profil existant
      // Ceci est une simulation de l'enregistrement
      
      const exerciseData = {
        type: "epellation_vocale",
        date: new Date().toISOString(),
        score: score,
        correctAnswers: correctAnswers,
        totalAttempts: totalAttempts,
        accuracy: Math.round((correctAnswers / totalAttempts) * 100),
        averageTime: responseTimes.length > 0 
          ? (responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length).toFixed(1)
          : "0",
        page: currentPage,
        wordsPerPage: pageSize
      };
      
      // Simulation de sauvegarde dans localStorage
      try {
        const savedScores = JSON.parse(localStorage.getItem('epellation_scores') || '[]');
        savedScores.push(exerciseData);
        localStorage.setItem('epellation_scores', JSON.stringify(savedScores));
        
        message.textContent = "‚úÖ Score enregistr√© avec succ√®s !";
        message.style.color = "#00e676";
        
        // D√©sactiver le bouton apr√®s sauvegarde
        btnSaveScore.disabled = true;
        btnSaveScore.textContent = "üíæ Score sauvegard√©";
        
        // Optionnel : envoyer les donn√©es √† votre backend
        console.log("Donn√©es √† envoyer au serveur:", exerciseData);
        
      } catch (error) {
        message.textContent = "‚ùå Erreur lors de l'enregistrement du score";
        message.style.color = "#ff5252";
        console.error("Erreur de sauvegarde:", error);
      }
    }

    /* === √âv√©nements === */
    btnPrevPage.addEventListener("click", () => {
      if (currentPage > 1) goToPage(currentPage - 1);
    });
    
    btnNextPage.addEventListener("click", () => {
      if (currentPage < totalPages) goToPage(currentPage + 1);
    });
    
    pageSelect.addEventListener("change", (e) => {
      const p = parseInt(e.target.value, 10);
      goToPage(p);
    });

    btnBack.addEventListener("click", prevWord);
    btnPlay.addEventListener("click", playWord);
    btnSlow.addEventListener("click", playWordSlow);
    btnFast.addEventListener("click", playWordFast);
    btnRepeat.addEventListener("click", repeatWord);
    btnSkip.addEventListener("click", nextWord);
    btnSaveScore.addEventListener("click", saveScore);

    answerInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") checkAnswer();
    });

    /* === Initialisation === */
    function initExercise() {
      sessionStartTime = Date.now();
      updateStats();
      updatePageSelect();
      goToPage(1);
    }

    // D√©marrer l'exercice
    window.addEventListener("load", initExercise);
  </script>
</body>
</html>
